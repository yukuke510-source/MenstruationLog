# 生理周期カレンダー自動計算（Notion × GitHub Actions）v2
**平均生理日数**の自動算出を追加しました。

このプロジェクトは、Notionデータベースに入力した**開始/終了の実績**から、
- 周期日数
- **平均周期（直近N周期）**
- **生理日数（開始〜終了）**
- **平均生理日数（直近N周期）** ✅ New
- 次回の生理予定日（= 最新開始 + 平均周期）
- 排卵予定日（= 次回予定日 − LUTEAL_DAYS）
を**自動算出**し、Notionへ書き戻します。さらに、カレンダーで見やすいように**タイトル（🩸開始/✅終了/📅生理予定/🔵排卵予定）**を自動付与します。

---

## 0. 前提（NotionのDB構成）

**テーブル例名:** 生理ログ

必須プロパティ（この名前で作るとそのまま動きます）:

| 表示名 | 種類 | 備考 |
|---|---|---|
| **タイトル** | Title | カードのタイトル（スクリプトが自動更新） |
| **記録日** | Date | 入力はこの1つのみ |
| **種別** | Select | 「開始」「終了」「予定」「排卵予定」 |
| 周期日数 | Number | 自動更新（開始行） |
| **平均周期** | Number | 自動更新（最新開始行） |
| 生理日数 | Number | 自動更新（終了行） |
| **平均生理日数** | Number | **自動更新（最新開始行）** |
| 次回生理予定日 | Date | 自動更新 |
| 排卵予定日 | Date | 自動更新 |
| 入力エラー | Checkbox | 検出時にON（任意） |
| 表示名 | Formula | 任意（カード下部に表示したい場合） |

**表示名（Formula）例**
```
if(prop("種別") == "開始", "🩸開始",
if(prop("種別") == "終了", "✅終了",
if(prop("種別") == "排卵予定", "🔵排卵予定",
if(prop("種別") == "予定", "📅生理予定", "📌記録"))))
```

> カレンダーの見出しは **タイトル** プロパティが使われます（本スクリプトが自動更新）。

**入力しやすくする工夫**
- DBテンプレート：「🩸開始を記録」「✅終了を記録」で種別を固定、追加時に記録日=今日を選択。

---

## 1. Notion インテグレーション
1. Notion → Settings → **My connections** → **Create new integration**（`NOTION_TOKEN` を取得）  
2. 生理ログDB → 右上 **••• → Add connections** で該当インテグレーションを**招待**

---

## 2. GitHub リポ準備
1. 本ZIPの中身を新規リポへプッシュ  
2. GitHub → Settings → **Secrets and variables → Actions**  
   - Secrets: `NOTION_TOKEN`, `NOTION_DATABASE_ID`  
   - Variables（任意）: `AVG_WINDOW`（既定6）, `AVG_BLEED_WINDOW`（既定6）, `LUTEAL_DAYS`（既定14）, `CYCLE_MIN`（17）, `CYCLE_MAX`（60）

---

## 3. Actions 実行
- `.github/workflows/period_automation.yml` 同梱。毎日 JST 0:00 に自動実行。  
- すぐ試す → Actions 画面の **Run workflow**。

---

## 4. ロジック概要（v2）
1. 「開始/終了」を**記録日昇順**で取得  
2. **周期日数**：連続する開始の差分 → 前の開始行へ書き戻し  
3. **生理日数**：開始→最初の終了（次開始の前）に対応付け、`終了−開始+1` を終了行へ  
4. **平均周期**：直近 `AVG_WINDOW` 周期の平均（異常値除外可）  
5. **平均生理日数**：直近 `AVG_BLEED_WINDOW` の生理日数の平均（終了行に値があるペアのみ集計） ✅  
6. **次回生理予定日**：`最新開始 + 平均周期` を DB/予定レコードに反映  
7. **排卵予定日**：`次回生理予定日 − LUTEAL_DAYS` を DB/予定レコードに反映  
8. **タイトル自動付与**：各行の Title を `🩸開始 08/30` などに整形  
9. **バリデーション**：同日重複や順序異常に **入力エラー** をON

---

## 5. ローカル実行（任意）
```bash
npm install
cp .env.example .env  # 値を入れる
node index.js
```

---

## 6. 運用フロー
- 入力：**記録日 + 種別（開始/終了）** を登録（履歴は全保存）  
- 自動結果：周期/平均周期/生理日数/**平均生理日数**/次回予定/排卵予定/タイトル更新  
- カレンダー：開始・終了・生理予定・排卵予定が常に可視化

---

## 7. カスタマイズ
- 集計窓の変更：`AVG_WINDOW` / `AVG_BLEED_WINDOW`  
- 黄体期日数：`LUTEAL_DAYS`  
- 異常値除外：`CYCLE_MIN` / `CYCLE_MAX`
